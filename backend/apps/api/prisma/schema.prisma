generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

model Campus {
  code      String   @id @db.VarChar(32) // 例如: nuist
  name      String
  city      String?
  centerLat Decimal? @db.Decimal(9, 6)
  centerLng Decimal? @db.Decimal(9, 6)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stores CampusStore[]
  users  User[]
}

model User {
  id         String   @id @default(uuid()) @db.Uuid
  campusCode String?  @db.VarChar(32)
  nickname   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campus   Campus?       @relation(fields: [campusCode], references: [code], onDelete: SetNull, onUpdate: Cascade)
  mealLogs MealLog[]
  reviews  StoreReview[]

  @@index([campusCode])
}

model CampusStore {
  id         String   @id @default(uuid()) @db.Uuid
  campusCode String   @db.VarChar(32)
  name       String
  area       String
  latitude   Decimal  @db.Decimal(9, 6)
  longitude  Decimal  @db.Decimal(9, 6)
  isOpen     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campus   Campus        @relation(fields: [campusCode], references: [code], onDelete: Restrict, onUpdate: Cascade)
  dishes   StoreDish[]
  mealLogs MealLog[]
  reviews  StoreReview[]

  @@unique([campusCode, name, area])
  @@index([campusCode])
  @@index([campusCode, name])
  @@index([latitude, longitude])
}

model StoreDish {
  id           String   @id @default(uuid()) @db.Uuid
  storeId      String   @db.Uuid
  name         String
  imageKey     String?  @db.VarChar(512)
  price        Decimal? @db.Decimal(10, 2)
  caloriesKcal Decimal? @db.Decimal(10, 2)
  proteinG     Decimal? @db.Decimal(10, 2)
  fatG         Decimal? @db.Decimal(10, 2)
  carbG        Decimal? @db.Decimal(10, 2)
  sodiumMg     Decimal? @db.Decimal(10, 2)
  fiberG       Decimal? @db.Decimal(10, 2)
  isAvailable  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  store    CampusStore @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  mealLogs MealLog[]

  @@unique([storeId, name])
  @@index([storeId, isAvailable])
  @@index([storeId, name])
}

model MealLog {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  loggedAt          DateTime
  mealType          MealType
  storeId           String?  @db.Uuid
  dishId            String?  @db.Uuid
  storeNameSnapshot String
  dishNameSnapshot  String
  priceSnapshot     Decimal? @db.Decimal(10, 2)
  nutritionSnapshot Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  store CampusStore? @relation(fields: [storeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  dish  StoreDish?   @relation(fields: [dishId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([userId, loggedAt(sort: Desc)])
  @@index([userId, mealType, loggedAt(sort: Desc)])
  @@index([storeId, loggedAt(sort: Desc)])
  @@index([dishId, loggedAt(sort: Desc)])
}

model StoreReview {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @db.Uuid
  storeId         String   @db.Uuid
  rating          Int
  content         String?
  recommendedDish String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  store CampusStore @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([storeId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
}
